# Инструкция по применению миграции

## ⚠️ ВАЖНО: Создайте резервную копию!

Перед применением миграции обязательно создайте резервную копию базы данных:

1. **В Supabase Dashboard**:
   - Перейдите в Database → Backups
   - Создайте новую резервную копию

2. **Или через CLI**:
   ```bash
   npx supabase db dump --data-only > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

## Применение миграции

### Вариант 1: Через Supabase CLI (рекомендуется)

```bash
# В корне проекта
npx supabase db push
```

### Вариант 2: Через Supabase Dashboard

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте содержимое файла `supabase/migrations/20250113000000_restructure_cards_schema.sql`
4. Вставьте и выполните

## Проверка после миграции

### 1. Проверьте структуру таблиц

```sql
-- Должны существовать новые таблицы
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('cards', 'user_cards', 'reviews');
```

### 2. Проверьте данные

```sql
-- Проверить количество карточек
SELECT COUNT(*) as total_cards FROM cards;
SELECT COUNT(*) as total_user_cards FROM user_cards;

-- Проверить, что дубликаты устранены
SELECT 
  language_pair_id, 
  term, 
  translation, 
  COUNT(*) as count
FROM cards
GROUP BY 1,2,3
HAVING COUNT(*) > 1;
-- Результат должен быть пустым
```

### 3. Проверьте функциональность

1. **Войдите в приложение**
2. **Проверьте карточки**:
   - Откройте раздел "Карточки"
   - Убедитесь, что карточки загружаются
3. **Проверьте добавление слов из уроков**:
   - Откройте урок "Приветствие и знакомство"
   - Нажмите "Добавить слова из урока"
   - Убедитесь, что слова добавляются без дубликатов

## Откат (если что-то пошло не так)

### Вариант 1: Восстановление из резервной копии

1. В Supabase Dashboard → Database → Backups
2. Выберите резервную копию, созданную перед миграцией
3. Восстановите базу данных

### Вариант 2: Ручной откат

```sql
-- Удалить новые таблицы
DROP TABLE IF EXISTS reviews;
DROP TABLE IF EXISTS user_cards;
DROP TABLE IF EXISTS cards;

-- Восстановить старую таблицу
ALTER TABLE cards_old RENAME TO cards;
```

## Что изменилось

### До миграции:
- Таблица `cards` содержала `user_id`
- Одинаковые карточки дублировались для каждого пользователя
- Контент и прогресс были смешаны

### После миграции:
- Таблица `cards` - общая библиотека (без `user_id`)
- Таблица `user_cards` - персональный прогресс
- Дубликаты устранены
- Улучшена производительность

## Поддержка

Если возникли проблемы:

1. **Проверьте логи** в Supabase Dashboard → Logs
2. **Проверьте RLS политики** в Database → Authentication → Policies
3. **Создайте issue** в репозитории с описанием проблемы

## Следующие шаги

После успешной миграции:

1. **Удалите старую таблицу** `cards_old` (через несколько дней после проверки)
2. **Обновите документацию** команды
3. **Проинформируйте пользователей** об улучшениях


















